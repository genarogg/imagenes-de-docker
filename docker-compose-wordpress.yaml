version: "3.9"
services:
  wordpress:
    image: "wordpress:latest"
    volumes:
      - "wordpress-files:/var/www/html"
      - "./uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro"
    environment:
      SERVICE_URL_WORDPRESS: "${SERVICE_URL_WORDPRESS}"
      WORDPRESS_DB_HOST: mysql
      WORDPRESS_DB_USER: "${SERVICE_USER_WORDPRESS}"
      WORDPRESS_DB_PASSWORD: "${SERVICE_PASSWORD_WORDPRESS}"
      WORDPRESS_DB_NAME: wordpress
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - curl
        - "-f"
        - "http://127.0.0.1"
      interval: 5s
      timeout: 10s
      retries: 10
    restart: unless-stopped
  mysql:
    image: "mysql:8"
    volumes:
      - "mysql-data:/var/lib/mysql"
    environment:
      MYSQL_ROOT_PASSWORD: "${SERVICE_PASSWORD_ROOT}"
      MYSQL_DATABASE: wordpress
      MYSQL_USER: "${SERVICE_USER_WORDPRESS}"
      MYSQL_PASSWORD: "${SERVICE_PASSWORD_WORDPRESS}"
    healthcheck:
      test:
        - CMD
        - mysqladmin
        - ping
        - "-h"
        - 127.0.0.1
      interval: 5s
      timeout: 20s
      retries: 10
    restart: unless-stopped
  filebrowser-init:
    image: "alpine:3.19"
    volumes:
      - "wordpress-files:/srv"
      - "filebrowser-data:/database"
      - "filebrowser-config:/config"
    command:
      - sh
      - -c
      - chown -R 33:33 /srv /database /config
    restart: "no"
  filebrowser:
    image: "filebrowser/filebrowser:latest"
    user: "33:33"
    depends_on:
      filebrowser-init:
        condition: service_completed_successfully
    volumes:
      - "wordpress-files:/srv"
      - "filebrowser-data:/database"
      - "filebrowser-config:/config"
    environment:
      FB_BASEURL: /filebrowser
    command: "--root /srv --database /database/filebrowser.db --config /config/settings.json"
    ports:
      - "8081:80"
    restart: unless-stopped
  sftp:
    image: atmoz/sftp
    volumes:
      - "wordpress-files:/home/wpuser/uploads"
    ports:
      - "${SFTP_PORT}:22"
    command: "wpuser:${SFTP_PASSWORD}:33"
    restart: unless-stopped
volumes:
  wordpress-files:
  mysql-data:
  filebrowser-data:
  filebrowser-config:


# agg un usuario admin a filebrowser
# filebrowser users add admin tuContrase√±a --perm.admin